pkgname=seafile-server
pkgver=1.7.1
pkgrel=1
pkgdesc="Seafile is an open-source Dropbox replacement."
arch=('i686' 'x86_64')
url="http://seafile.com"
license=('GPLv3')
depends=('glib2>=2.28' 'libevent>=2.0' 'curl' 'util-linux' 'intltool>=0.40' 'sqlite>=3.7' 'libmysqlclient>=5.5' 'python2-mako' 'python2-webpy' 'python2-simplejson' 'python2-imaging' 'python2-chardet' 'python2-pip' 'python2-virtualenv' 'gunicorn' 'python2-djblets' 'ccnet>=1.3.3' 'libsearpc>=1.1.0' 'libevhtp' 'seafile-common' 'django-rest-framework')
makedepends=('pacman>=4.1')
optdepends=()
provides=()
conflicts=('seafile')

options=
install=seafile-server.install

source=("https://seafile.googlecode.com/files/seafile-${pkgver}.tar.gz"
	"seafile-admin.patch"
    "common-cleanup.txt")
sha256sums=('8bce8f727deebc71c04a0e1b6ad3d9d39a6454858128a0e75e1903d59fabef79'
	'0d9578b85c00f3087a19f227b29c3fda13e83d093d024c68c1df5575d30d56dc'
    '84db644002f3d73efa552229cf23677e118b2642b69b39f12c9232549cd78acf')

prepare () {
	cd "$srcdir/${pkgname/-server/}-$pkgver"
	patch -p1 -i $srcdir/seafile-admin.patch
}

build () {
	cd "$srcdir/${pkgname/-server/}-$pkgver"
	./configure --enable-server --disable-client --prefix=/usr PYTHON=/usr/bin/python2
	make -j1
}

package () {
    # normal install
	cd "$srcdir/${pkgname/-server/}-$pkgver"
	make DESTDIR="$pkgdir/" install
    # cleanup common files
    for F in $(<"$srcdir/common-cleanup.txt")
    do
        rm "$pkgdir/$F"
    done
    # make dirs ready
    mkdir -p "$pkgdir/opt/seafile/server/seafile-server"
    ln -s ../../seahub "$pkgdir/opt/seafile/server/seafile-server/seahub"
}
